<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Categoria</title>
  <link rel="stylesheet" href="/css/style.css">

  <style>
    body {
      display: flex;
      flex-direction: row;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f9fff3;
      overflow: hidden;
    }

    .sidebar {
      width: 220px;
      background-color: #c8e0a4;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }

    .main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 20px;
    }

    h1 { margin-bottom: 20px; }

    /* ====== FLASHCARD ====== */
    .flashcard {
      width: 450px;
      height: 600px;
      background: transparent !important;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      perspective: 1500px;
      position: relative;
      cursor: grab;
      user-select: none;
      transition: transform 0.4s ease;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      overflow: visible;
    }

    .flashcard-inner {
      position: absolute;
      width: 100%;
      height: 100%;
      transition: transform 0.9s cubic-bezier(0.4, 0.2, 0.2, 1);
      transform-style: preserve-3d;
    }

    .flashcard.is-flipped .flashcard-inner {
      transform: rotateY(180deg);
    }

    .flashcard-front, .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      padding: 30px;
      backface-visibility: hidden;
      border-radius: 20px;
      box-sizing: border-box;
    }

    .flashcard-front { background: #c8e0a4; }
    .flashcard-back { background: #a8c67a; transform: rotateY(180deg); }

    .hover-icon {
      position: absolute;
      top: 50%;
      transform: translateY(-50%) scale(0);
      opacity: 0;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      color: white;
      font-size: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }

    .hover-icon.right { right: -100px; background: #4CAF50; }
    .hover-icon.left { left: -100px; background: #E74C3C; }

    @keyframes symbolFromBehind {
      0% { opacity: 0; transform: translateZ(-120px) translateY(-50%) scale(0.5); }
      60% { opacity: 1; transform: translateZ(40px) translateY(-50%) scale(1.1); }
      100% { transform: translateZ(0) translateY(-50%) scale(1); opacity: 1; }
    }

    .flashcard:hover .hover-icon.right { animation: symbolFromBehind 0.6s forwards; }
    .flashcard:hover .hover-icon.left { animation: symbolFromBehind 0.6s forwards; }

    .flashcard.left-hover { transform: rotate(-6deg) translateX(-10px); }
    .flashcard.right-hover { transform: rotate(6deg) translateX(10px); }

    .flashcard.throw-right { animation: throwRight 0.6s ease-out forwards; }
    .flashcard.throw-left { animation: throwLeft 0.6s ease-out forwards; }

    @keyframes throwRight {
      0% { transform: translateX(0) rotate(0deg); opacity: 1; }
      100% { transform: translateX(600px) rotate(20deg); opacity: 0; }
    }

    @keyframes throwLeft {
      0% { transform: translateX(0) rotate(0deg); opacity: 1; }
      100% { transform: translateX(-600px) rotate(-20deg); opacity: 0; }
    }

    .arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 50px;
      height: 50px;
      background: #c8e0a4;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: background 0.3s;
      z-index: 10;
    }

    .arrow:hover { background: #b1d084; }
    .arrow.left { left: 60px; }
    .arrow.right { right: 60px; }

    .add-flashcard-btn {
      position: absolute;
      top: 20px;
      right: 40px;
      background: #a8c67a;
      color: #fff;
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .add-flashcard-btn:hover { background: #91b268; }

    .scoreboard {
      position: absolute;
      bottom: 20px;
      display: flex;
      gap: 30px;
      font-size: 1.2rem;
      align-items: center;
      justify-content: center;
    }

    .score-item { display: flex; align-items: center; gap: 8px; }
    .score-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }
    .score-circle.correct { background: #4CAF50; }
    .score-circle.wrong { background: #E74C3C; }

    /* delete button (square X) for flashcard */
    .delete-x-square-flash {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: 2px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      z-index: 5;
    }
    .delete-x-square-flash:hover {
      background: #ffecec;
      color: #d33;
      border-color: #f3b3b3;
    }

    /* modal (shared) */
    .confirm-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    .confirm-backdrop.show { display: flex; }

    .confirm-box {
      width: 380px;
      max-width: calc(100% - 40px);
      background: #f9fff3;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      border: 1px solid rgba(0,0,0,0.04);
      text-align: center;
      font-family: Arial, sans-serif;
    }

    .confirm-title {
      font-size: 18px;
      color: #2f3b2a;
      margin-bottom: 10px;
      font-weight: 700;
    }
    .confirm-text {
      font-size: 14px;
      color: #3b3f2b;
      margin-bottom: 18px;
    }
    .confirm-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .btn-confirm {
      background: #a8c67a;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-cancel {
      background: transparent;
      color: #3b3f2b;
      border: 1px solid rgba(0,0,0,0.06);
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
    }
  </style>

</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>MedVest+</h2>
    <a href="/index.html" class="nav-link">Início</a>
    <a href="./simulados.html" class="nav-link">Simulados</a>
    <a href="./flashcards.html" class="nav-link">Flashcards</a>
    <a href="./notificacoes.html" class="nav-link">Notificações</a>
    <a href="./perfil.html" class="nav-link">Perfil</a>
    <img src="/assets/images/logo.png" alt="logo">
  </div>

  <!-- MAIN -->
  <div class="main">
    <h1 id="categoryTitle"></h1>
    <a id="addFlashcardBtn" class="add-flashcard-btn">+ Novo Flashcard</a>

    <div id="flashcardContainer"></div>

    <div class="arrow left" id="prevBtn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </div>
    <div class="arrow right" id="nextBtn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </div>

    <div class="scoreboard">
      <div class="score-item">
        <div class="score-circle correct">✔</div>
        <span id="correctCount">0</span>
      </div>
      <div class="score-item">
        <div class="score-circle wrong">✖</div>
        <span id="wrongCount">0</span>
      </div>
    </div>
  </div>

  <!-- Confirm modal (shared) -->
  <div id="confirmBackdrop" class="confirm-backdrop" aria-hidden="true">
    <div class="confirm-box" role="dialog" aria-modal="true">
      <div class="confirm-title">Confirmar exclusão</div>
      <div id="confirmText" class="confirm-text">Tem certeza?</div>
      <div class="confirm-actions">
        <button id="confirmNo" class="btn-cancel">Cancelar</button>
        <button id="confirmYes" class="btn-confirm">Excluir</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT -> Firebase + Render -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBN2_GgoK-nXfOxefYlCE9i7PupwrNQkrY",
  authDomain: "medvestplus.firebaseapp.com",
  projectId: "medvestplus",
  storageBucket: "medvestplus.firebasestorage.app",
  messagingSenderId: "261146979409",
  appId: "1:261146979409:web:3388c61d54f7d7f7205c70",
  databaseURL: "https://medvestplus-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const params = new URLSearchParams(window.location.search);
const nome = params.get("nome");
const tipo = params.get("tipo");
document.getElementById("categoryTitle").textContent = nome;

const addBtn = document.getElementById("addFlashcardBtn");
addBtn.href = `novoflashcard.html?nome=${encodeURIComponent(nome)}&tipo=${encodeURIComponent(tipo)}`;

const container = document.getElementById("flashcardContainer");
let flashcards = [];
let currentIndex = 0;

let correct = 0;
let wrong = 0;

let UID = null;

onAuthStateChanged(auth, (user) => {
  if (!user) return;
  UID = user.uid;

  const refCards = ref(db, `usuarios/${UID}/categoria/${tipo}/${nome}/flashcards`);

  onValue(refCards, (snap) => {
    const data = snap.val() || {};
    flashcards = Object.entries(data).map(([id, item]) => ({ _id: id, ...item }));

    currentIndex = 0;
    renderFlashcard(currentIndex);
  });
});

function openConfirm(message, onConfirm) {
  const backdrop = document.getElementById("confirmBackdrop");
  const txt = document.getElementById("confirmText");
  txt.textContent = message;
  backdrop.classList.add("show");

  const yes = document.getElementById("confirmYes");
  const no = document.getElementById("confirmNo");

  const cleanup = () => {
    backdrop.classList.remove("show");
    yes.onclick = null;
    no.onclick = null;
  };

  yes.onclick = async () => {
    try {
      await onConfirm();
    } catch (err) {
      console.error(err);
    } finally {
      cleanup();
    }
  };
  no.onclick = cleanup;
}

function renderFlashcard(index) {
  container.innerHTML = "";

  if (flashcards.length === 0) {
    container.innerHTML = "<p>Não há flashcards nesta categoria.</p>";
    return;
  }

  const fc = flashcards[index];

  const div = document.createElement("div");
  div.className = "flashcard";

  div.innerHTML = `
    <div class="flashcard-inner">
      <div class="flashcard-front">${fc.frente}</div>
      <div class="flashcard-back">${fc.verso}</div>
    </div>
    <div class="hover-icon left">✖</div>
    <div class="hover-icon right">✔</div>
  `;

  const del = document.createElement("div");
  del.className = "delete-x-square-flash";
  del.innerHTML = "✖";
  del.addEventListener("click", (e) => {
    e.stopPropagation();
    openConfirm("Excluir este flashcard?", async () => {
      await remove(ref(db, `usuarios/${UID}/categoria/${tipo}/${nome}/flashcards/${fc._id}`));
      flashcards.splice(currentIndex, 1);
      if (flashcards.length === 0) {
        container.innerHTML = "<p>Não há flashcards nesta categoria.</p>";
        return;
      }
      currentIndex = currentIndex % flashcards.length;
      renderFlashcard(currentIndex);
    });
  });

  div.appendChild(del);

  div.addEventListener("click", (e) => {
    if (Math.abs(e.offsetX - div.offsetWidth / 2) < 200) {
      div.classList.toggle("is-flipped");
    }
  });

  div.addEventListener("mousemove", (e) => {
    const rect = div.getBoundingClientRect();
    const mid = rect.left + rect.width / 2;
    const diff = e.clientX - mid;
    const maxTilt = 8;

    let tilt = 0;
    const dist = Math.abs(diff);
    if (dist > 100) {
      const factor = (dist - 100) / (rect.width / 2 - 100);
      tilt = Math.sign(diff) * Math.min(maxTilt, factor * maxTilt);
    }

    div.style.transform = `rotate(${tilt}deg)`;
  });

  div.addEventListener("mouseleave", () => {
    div.style.transform = "rotate(0deg)";
  });

  let startX = 0;
  let dragging = false;

  div.addEventListener("mousedown", (e) => {
    dragging = true;
    startX = e.clientX;
    div.style.transition = "none";
  });

  document.addEventListener("mouseup", (e) => {
    if (!dragging) return;
    dragging = false;
    div.style.transition = "transform 0.3s";

    const dx = e.clientX - startX;

    if (dx > 100) {
      div.classList.add("throw-right");
      setTimeout(() => {
        correct++;
        document.getElementById("correctCount").textContent = correct;
        nextFlashcard();
      }, 300);
    } else if (dx < -100) {
      div.classList.add("throw-left");
      setTimeout(() => {
        wrong++;
        document.getElementById("wrongCount").textContent = wrong;
        nextFlashcard();
      }, 300);
    } else {
      div.style.transform = "translateX(0) rotate(0)";
    }
  });

  document.addEventListener("mousemove", (e) => {
    if (!dragging) return;
    const dx = e.clientX - startX;
    const tilt = Math.max(-10, Math.min(10, dx / 15));
    div.style.transform = `translateX(${dx}px) rotate(${tilt}deg)`;
  });

  container.appendChild(div);
}

function nextFlashcard() {
  if (flashcards.length === 0) return;
  currentIndex = (currentIndex + 1) % flashcards.length;
  renderFlashcard(currentIndex);
}

document.getElementById("prevBtn").addEventListener("click", () => {
  if (flashcards.length === 0) return;
  currentIndex = (currentIndex - 1 + flashcards.length) % flashcards.length;
  renderFlashcard(currentIndex);
});

document.getElementById("nextBtn").addEventListener("click", nextFlashcard);

  </script>

</body>
</html>
